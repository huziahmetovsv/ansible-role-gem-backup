{% for model_stor in item.storages %}
{% for stor in gem_backup_storages %}
{% if stor.name == model_stor %}
{% if stor.type == 's3' %}
  ##
  # Amazon Simple Storage Service [Storage]
  #
  store_with S3 do |s3|
    # AWS Credentials
    s3.access_key_id     = "{{ stor.access_key }}"
    s3.secret_access_key = "{{ stor.secret_access_key }}"
    s3.region            = "{{ stor.region|default('us-east-1') }}"
    s3.bucket            = "{{ stor.bucket }}"
    s3.path              = "{{ stor.path|default('') }}"
    s3.keep              = {{ stor.keep|default(14) }}
    s3.max_retries       = {{ stor.max_retries|default(10) }}
    s3.retry_waitsec     = {{ stor.retry_waitsec|default(30) }}
{% if stor.fog_options is defined %}
    s3.fog_options = {
    {% for k, v in stor.fog_options.items() %}
        {{ k }}: {{ v | lower }},
    {% endfor %}
    }
{% endif %}
  end
{% endif %}
{% if stor.type == 'scp' or stor.type == 'sftp' %}
  ##
  # SCP/SFTP (Secure Copy) [Storage]
  #
  store_with {{ stor.type| upper }} do |server|
    server.username   = "{{ stor.username }}"
{% if stor.password is defined %}
    server.password   = "{{ stor.password }}"
{% endif %}
    server.ip         = "{{ stor.host }}"
    server.port       = "{{ stor.port|default(22) }}"
    server.path       = "{{ stor.path }}"
    server.keep       = {{ stor.keep|default(14) }}
    # Additional options for the SSH connection.
    server.ssh_options = {{ stor.ssh_options|d({}) }}
  end
{% endif %}
{% if stor.type == 'ftp' %}
  ##
  # FTP [Storage]
  #
  store_with FTP do |server|
    server.username   = "{{ stor.username }}"
    server.password   = "{{ stor.password }}"
    server.ip         = "{{ stor.host }}"
    server.port       = "{{ stor.port|default(21) }}"
    server.path       = "{{ stor.path }}"
    server.keep       = {{ stor.keep|default(14) }}
    server.passive_mode = {{ stor.passive_mode|default(false) }}
    # Configures open_timeout and read_timeout for Net::FTP
    server.timeout      = {{ stor.timeout|default(10) }}
  end
{% endif %}
{% if stor.type == 'local' %}
  ##
  # Local (Copy) [Storage]
  #
  store_with Local do |local|
    local.path       = "{{ stor.path }}"
    local.keep       = {{ stor.keep|default(14) }}
  end
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
